package aima.core.probability.bayes.impl;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import aima.core.probability.CategoricalDistribution;
import aima.core.probability.Factor;
import aima.core.probability.RandomVariable;
import aima.core.probability.bayes.BayesianNetwork;
import aima.core.probability.bayes.Node;
import aima.core.probability.bayes.exact.EliminationAsk;
import aima.core.probability.proposition.AssignmentProposition;

public class IalabDBN extends DynamicBayesNet {

	// It is the current slice of the rollupfiltering algorithm
	private DynamicBayesNet currentSlice;

	// the updated CPT for each node in keys
	private Map<Node, CategoricalDistribution> lastCPTs;

	public IalabDBN(BayesianNetwork priorNetwork, Map<RandomVariable, RandomVariable> X_0_to_X_1,
			Set<RandomVariable> E_1, Node[] rootNodes) {
		super(priorNetwork, X_0_to_X_1, E_1, rootNodes);
		this.currentSlice = new DynamicBayesNet(priorNetwork, X_0_to_X_1, E_1, rootNodes);

	}

	public IalabDBN(BayesianNetwork priorNetwork, Map<RandomVariable, RandomVariable> X_0_to_X_1,
			Set<RandomVariable> E_1, Node[] rootNodes, DynamicBayesNet currentSlice) {
		super(priorNetwork, X_0_to_X_1, E_1, rootNodes);
		this.currentSlice = currentSlice;

	}

	
	
	public List<Factor> forward(AssignmentProposition[] observations, EliminationAsk inference, Set<Factor> factors_last_step,List<RandomVariable> queryVars) {

		lastCPTs = new HashMap<>();
		List<Factor> factors = new ArrayList<>();

		//calcolo il termine di filtering
		/*for (RandomVariable x0 : currentSlice.getX_0_to_X_1().keySet()) {
			RandomVariable x1 = currentSlice.getX_0_to_X_1().get(x0);
			
			// eseguo VE
			factors.addAll(0, inference.eliminationAskWithFactors(new RandomVariable[]{x1}, observations, currentSlice, new ArrayList<>(factors_last_step)));

			
			Node node = currentSlice.getNode(x0);
			node.updateCPT(null, x0, EliminationAsk.getProbTableFromFactors(factors,queryVars).getValues());
		}*/
		factors = inference.eliminationAskWithFactors(queryVars.toArray(new RandomVariable[queryVars.size()]), observations, currentSlice, new HashSet<>(factors_last_step));
		
		return factors;
		
		

	}

	public DynamicBayesNet getCurrentSlice() {
		return currentSlice;
	}

	public Map<Node, CategoricalDistribution> getLastCPTs() {
		return lastCPTs;
	}

}
